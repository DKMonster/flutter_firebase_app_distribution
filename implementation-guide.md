# Firebase App Distribution 實作指南

## 📋 前置準備

### 1. 環境需求
- Flutter SDK (3.0+)
- Firebase CLI
- Android Studio
- Node.js (用於 Firebase CLI)

### 2. 安裝 Firebase CLI
```bash
# 使用 npm 安裝
npm install -g firebase-tools

# 或使用 brew (macOS)
brew install firebase-cli

# 驗證安裝
firebase --version
```

### 3. Firebase 登入
```bash
# 登入 Firebase
firebase login

# 確認登入狀態
firebase projects:list
```

## 🔧 專案設定

### 1. Flutter Flavors 設定

#### 建立 Flavor 設定檔
`android/app/flavorizr.gradle.kts`:
```kotlin
import com.android.build.gradle.AppExtension

val android = project.extensions.getByType(AppExtension::class.java)

android.apply {
    flavorDimensions("flavor-type")

    productFlavors {
        create("production") {
            dimension = "flavor-type"
            applicationId = "com.uspace"
            resValue(type = "string", name = "app_name", value = "USPACE")
        }
        create("staging") {
            dimension = "flavor-type"
            applicationId = "com.uspace.uspacepremium.staging"
            resValue(type = "string", name = "app_name", value = "USPACE Staging")
        }
        create("development") {
            dimension = "flavor-type"
            applicationId = "com.uspace.uspacepremium.dev"
            resValue(type = "string", name = "app_name", value = "USPACE Development")
        }
    }
}
```

#### 更新 build.gradle.kts
在 `android/app/build.gradle.kts` 最後加入：
```kotlin
// ----- BEGIN flavorDimensions (autogenerated by flutter_flavorizr) -----
apply { from("flavorizr.gradle.kts") }
// ----- END flavorDimensions (autogenerated by flutter_flavorizr) -----
```

### 2. Firebase 專案設定

#### 在 Firebase Console 建立應用程式
1. 前往 [Firebase Console](https://console.firebase.google.com)
2. 選擇或建立專案
3. 新增 Android 應用程式：
   - Production: `com.uspace`
   - Staging: `com.uspace.uspacepremium.staging`
   - Development: `com.uspace.uspacepremium.dev`

#### 下載設定檔
為每個 Flavor 下載對應的 `google-services.json`：
```
android/app/src/
├── production/google-services.json
├── staging/google-services.json
└── development/google-services.json
```

### 3. 啟用 App Distribution
1. 在 Firebase Console 中
2. 選擇「Release & Monitor」→「App Distribution」
3. 開始使用

## 📝 腳本設定

### 1. 建立部署腳本
將 `deploy_android_firebase.sh` 放置在專案的 `scripts/` 目錄下。

### 2. 設定執行權限
```bash
chmod +x scripts/deploy_android_firebase.sh
```

### 3. 更新 Firebase App ID
編輯腳本中的 App ID 部分：
```bash
case $flavor in
    "development")
        firebase_cmd="$firebase_cmd --app YOUR_DEVELOPMENT_APP_ID"
        ;;
    "staging")
        firebase_cmd="$firebase_cmd --app YOUR_STAGING_APP_ID"
        ;;
    "production")
        firebase_cmd="$firebase_cmd --app YOUR_PRODUCTION_APP_ID"
        ;;
esac
```

從 Firebase Console 取得 App ID：
1. 專案設定 → 應用程式
2. 複製「應用程式 ID」（格式通常為 `1:xxxxx:android:xxxxx`）

## 🚀 使用方式

### 基本使用
```bash
# 部署開發版本
./scripts/deploy_android_firebase.sh -f development

# 部署測試版本
./scripts/deploy_android_firebase.sh -f staging

# 部署生產版本
./scripts/deploy_android_firebase.sh -f production
```

### 進階使用
```bash
# 指定測試群組
./scripts/deploy_android_firebase.sh -f staging -g beta-testers

# 加入發布說明
./scripts/deploy_android_firebase.sh -f staging -r release_notes.txt

# 完整範例
./scripts/deploy_android_firebase.sh \
    -f staging \
    -g qa-team \
    -r docs/release_notes_v1.2.0.txt
```

### 建立發布說明檔案
`release_notes.txt`:
```
版本 1.2.0 更新內容：

新功能：
- 新增用戶個人資料頁面
- 支援深色模式

修復：
- 修正登入時的閃退問題
- 改善列表滾動效能

已知問題：
- 某些 Android 裝置上的相機功能異常
```

## 👥 測試者管理

### 1. 建立測試群組
在 Firebase Console：
1. App Distribution → 測試者與群組
2. 建立群組（例如：qa-team、beta-testers、internal）
3. 新增測試者郵件

### 2. 邀請測試者
```bash
# 自動發送邀請給群組成員
./scripts/deploy_android_firebase.sh -f staging -g beta-testers
```

### 3. 測試者安裝流程
1. 測試者收到邀請郵件
2. 下載 Firebase App Tester 應用程式
3. 登入並接受邀請
4. 下載並安裝測試版本

## 🔍 疑難排解

### 常見問題

#### 1. Firebase CLI 未登入
```bash
錯誤: 未登入 Firebase
解決: firebase login
```

#### 2. Flutter 命令找不到
```bash
錯誤: Flutter 未安裝或不在 PATH 中
解決: export PATH="$PATH:/path/to/flutter/bin"
```

#### 3. APK 建置失敗
```bash
# 清理並重新建置
flutter clean
flutter pub get
flutter build apk --flavor staging --release
```

#### 4. Firebase App ID 錯誤
```bash
錯誤: Failed to authenticate
解決: 確認 App ID 正確，從 Firebase Console 複製
```

### 除錯技巧

1. **啟用詳細日誌**
```bash
firebase appdistribution:distribute --debug ...
```

2. **檢查建置輸出**
```bash
# 確認 APK 存在
ls -la build/app/outputs/flutter-apk/
```

3. **驗證 Firebase 專案**
```bash
firebase projects:list
firebase use YOUR_PROJECT_ID
```

## 🔄 CI/CD 整合

### GitHub Actions 範例
`.github/workflows/deploy-staging.yml`:
```yaml
name: Deploy Staging to Firebase

on:
  push:
    branches: [ staging ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Authenticate Firebase
        run: |
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > firebase-key.json
          export GOOGLE_APPLICATION_CREDENTIALS="firebase-key.json"
      
      - name: Deploy to Firebase
        run: ./scripts/deploy_android_firebase.sh -f staging
```

## 📊 監控與分析

### 查看部署狀態
1. Firebase Console → App Distribution
2. 查看版本列表
3. 檢視下載統計

### 測試者回饋
- 使用 Firebase Crashlytics 收集崩潰報告
- 整合 Firebase Analytics 追蹤使用行為

## 🎯 最佳實踐

1. **版本命名**
   - 使用語意化版本（例如：1.2.0）
   - 在發布說明中清楚說明變更

2. **測試群組策略**
   - 內部測試：開發團隊
   - Alpha 測試：QA 團隊
   - Beta 測試：選定的外部用戶

3. **發布週期**
   - Development：每日建置
   - Staging：每週發布
   - Production：雙週或月度發布

4. **安全考量**
   - 不要在腳本中硬編碼敏感資訊
   - 使用環境變數或設定檔
   - 定期更新簽名憑證

---
最後更新：2025-07-29